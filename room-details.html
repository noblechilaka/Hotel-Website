<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loading Room | EMILY HOTEL</title>
    <meta
      name="description"
      content="View room details and amenities. Book your perfect stay at EMILY HOTEL."
    />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=close"
    />
    <!-- Styles -->
    <link rel="stylesheet" href="/styles/global.css" />
    <link rel="stylesheet" href="/styles/typography.css" />
    <link rel="stylesheet" href="/styles/layout.css" />
    <link rel="stylesheet" href="/styles/components.css" />
    <link rel="stylesheet" href="/styles/animations.css" />

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <!-- Lenis Smooth Scrolling -->
    <script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>

    <!-- Flatpickr for date picking -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Room Data - Load first for immediate access -->
    <script src="/scripts/rooms-data.js"></script>
  </head>
  <body class="room-details-page">
    <!-- Scroll Progress -->
    <div class="scroll-progress"></div>

    <!-- Loading State -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-content">
        <span class="loading-logo">EMILY HOTEL</span>
        <div class="loading-spinner"></div>
        <span class="loading-text">Preparing your sanctuary...</span>
      </div>
    </div>

    <!-- Header -->
    <header class="header">
      <div class="header-inner">
        <!-- Menu Toggle - Left -->
        <button
          class="header-menu"
          id="menuToggle"
          aria-label="Open navigation menu"
        >
          <div class="menu-icon">
            <span></span>
            <span></span>
          </div>
          <span class="menu-text">MENU</span>
        </button>

        <!-- Logo - Centered -->
        <div class="header-logo">
          <a href="/index.html" class="logo">EMILY HOTEL</a>
        </div>

        <!-- Navigation - Right -->
        <nav class="header-nav-right">
          <a href="/signup.html" class="nav-link">JOIN US</a>
          <button type="submit" class="booking-cta" id="bookNowBtn">
            BOOK NOW
          </button>
        </nav>

        <!-- Mobile Menu Toggle - Visible on mobile only -->
        <button
          class="menu-toggle"
          id="mobileMenuToggle"
          aria-label="Toggle navigation"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            x="0px"
            y="0px"
            width="24"
            height="24"
            viewBox="0 0 32 32"
          >
            <path
              d="M 4 7 L 4 9 L 28 9 L 28 7 L 4 7 z M 4 15 L 4 17 L 28 17 L 28 15 L 4 15 z M 4 23 L 4 25 L 28 25 L 28 23 L 4 23 z"
            ></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Navigation Menu Panel -->
    <div
      class="menu-overlay"
      id="menuOverlay"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
    >
      <nav class="menu-panel" aria-label="Main navigation">
        <ul class="menu-list">
          <li class="menu-item">
            <a href="/index.html" class="menu-link">Home</a>
          </li>
          <li class="menu-item">
            <a href="/rooms.html" class="menu-link">Rooms & Suites</a>
          </li>
          <li class="menu-item">
            <a href="/about.html" class="menu-link">About Us</a>
          </li>
          <li class="menu-item">
            <a href="#" class="menu-link">Experiences</a>
          </li>
          <li class="menu-item">
            <a href="/gallery.html" class="menu-link">Gallery</a>
          </li>
          <li class="menu-item">
            <a href="/contact.html" class="menu-link">Contact</a>
          </li>
          <li class="menu-item menu-divider"></li>
          <li class="menu-item">
            <a href="#" class="menu-link menu-link-secondary">JOIN US</a>
          </li>
          <li class="menu-item">
            <a href="#" class="menu-link menu-link-cta">Book Your Stay</a>
          </li>
        </ul>
        <button
          class="menu-close"
          id="menuClose"
          aria-label="Close navigation menu"
        >
          <span class="material-symbols-outlined"> close </span>Close
        </button>
      </nav>
    </div>

    <main id="main-content" style="opacity: 0;">
      <!-- Page Header - Dynamically Populated -->
      <section class="hero-pages" style="min-height: 50vh">
        <img
          id="hero-bg-image"
          src=""
          alt="Room Interior"
          class="hero-bg"
        />
        <div class="hero-overlay"></div>

        <div class="hero_content" style="padding-top: 150px">
          <span
            class="meta-text gold"
            id="hero-category"
            style="margin-bottom: 1rem; display: block"
            >Accommodations</span
          >
          <h1
            class="hero-heading"
            id="hero-title"
            style="font-size: clamp(3rem, 8vw, 6rem)"
          >
            <span class="line"><span>The Rooms &</span></span>
            <span class="line"><span class="text-gold">Suites</span></span>
          </h1>
        </div>
      </section>

      <!-- Room Gallery - Dynamically Populated -->
      <section class="section-padding" style="padding-bottom: 0">
        <div class="container">
          <!-- Main Image -->
          <div style="margin-bottom: var(--space-md)">
            <img
              id="main-image"
              src=""
              alt="Room View"
              style="
                width: 100%;
                height: 70vh;
                object-fit: cover;
                border-radius: 4px;
              "
            />
          </div>

          <!-- Thumbnails Container -->
          <div
            id="gallery-container"
            class="room-gallery"
            style="
              display: grid;
              grid-template-columns: repeat(4, 1fr);
              gap: var(--space-sm);
            "
          >
            <!-- Gallery thumbnails loaded dynamically -->
          </div>
        </div>
      </section>

      <!-- Room Details & Booking - Dynamically Populated -->
      <section class="section-padding">
        <div class="container">
          <div class="room-details-section">
            <!-- Room Info -->
            <div class="room-details" id="room-details-content">
              <!-- Content loaded dynamically -->
            </div>

            <!-- Booking Widget -->
            <div class="booking-widget sticky-widget" id="booking-widget">
              <!-- Content loaded dynamically -->
            </div>
          </div>
        </div>
      </section>

      <!-- Related Rooms - Dynamically Populated -->
      <section class="section-padding bg-dark">
        <div class="container">
          <h2
            class="section-title"
            style="color: var(--text-light); margin-bottom: 2rem"
          >
            You May Also Like
          </h2>

          <div
            id="related-rooms-container"
            style="
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: var(--space-md);
            "
          >
            <!-- Related rooms loaded dynamically -->
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-grid">
        <div class="footer-brand">
          <span class="footer-logo">EMILY HOTEL</span>
          <p class="footer-tagline">
            Where timeless elegance meets contemporary design. Experience the
            art of hospitality.
          </p>
        </div>

        <div class="footer-col">
          <h4 class="footer-title">Explore</h4>
          <ul class="footer-links">
            <li><a href="/rooms.html">Rooms & Suites</a></li>
            <li><a href="#">Dining</a></li>
            <li><a href="#">Spa & Wellness</a></li>
            <li><a href="#">Experiences</a></li>
          </ul>
        </div>

        <div class="footer-col">
          <h4 class="footer-title">Company</h4>
          <ul class="footer-links">
            <li><a href="/about.html">About Us</a></li>
            <li><a href="#">Careers</a></li>
            <li><a href="/contact.html">Contact</a></li>
            <li><a href="#">Press</a></li>
          </ul>
        </div>

        <div class="footer-col">
          <h4 class="footer-title">Contact</h4>
          <ul class="footer-links">
            <li>123 Luxury Avenue</li>
            <li>New York, NY 10001</li>
            <li>+1 (212) 555-0123</li>
            <li>reservations@emilyhotel.com</li>
          </ul>
        </div>
      </div>

      <div class="footer-bottom">
        <span class="footer-copyright"
          >© 2024 Grand Emily Hotel. All rights reserved.</span
        >
        <div class="footer-social">
          <a href="#" class="social-link">Instagram</a>
          <a href="#" class="social-link">Facebook</a>
          <a href="#" class="social-link">Twitter</a>
        </div>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="/scripts/main.js"></script>
    <script src="/scripts/animations.js"></script>
    <script src="/scripts/supabase.js"></script>
    <script src="/scripts/auth.js"></script>
    <script src="/scripts/booking.js"></script>

    <script>
      // Initialize page with dynamic content immediately
      (function() {
        'use strict';

        // Get room data immediately
        const params = new URLSearchParams(window.location.search);
        const roomSlug = params.get('room') || 'garden-studio';
        const roomData = window.RoomManager.initRoomDetailsPage(roomSlug);
        const room = roomData.rawRoom;

        // Update page title
        document.title = roomData.title;

        // Update hero section
        const heroBgImage = document.getElementById('hero-bg-image');
        heroBgImage.src = roomData.heroImage;
        heroBgImage.alt = roomData.heroName;
        
        document.getElementById('hero-category').textContent = roomData.roomCategory;
        document.getElementById('hero-title').innerHTML = `
          <span class="line"><span>${roomData.roomName.split(' ').slice(0, -1).join(' ')}</span></span>
          <span class="line"><span class="text-gold">${roomData.roomName.split(' ').slice(-1)}</span></span>
        `;

        // Update main image
        document.getElementById('main-image').src = roomData.mainImage;
        document.getElementById('main-image').alt = roomData.roomName;

        // Update gallery
        document.getElementById('gallery-container').innerHTML = roomData.gallery;

        // Build room details content
        const roomDetailsContent = document.getElementById('room-details-content');
        roomDetailsContent.innerHTML = `
          <span class="meta-text gold">${roomData.roomCategory}</span>
          <h1 class="section-title" style="margin-bottom: 1rem">
            ${roomData.roomName}
          </h1>
          <p class="body-text" style="margin-bottom: 2rem">
            ${roomData.roomDescription}
          </p>

          <!-- Room Stats -->
          <div
            style="
              display: flex;
              gap: var(--space-xl);
              margin-bottom: 2rem;
              padding: 1.5rem;
              background: var(--bg-light);
              border-radius: 4px;
            "
          >
            <div>
              <span class="stat-number">${roomData.roomSize}</span>
              <span class="stat-label">${roomData.roomSizeUnit}</span>
            </div>
            <div>
              <span class="stat-number">${roomData.bedType}</span>
              <span class="stat-label">Bed</span>
            </div>
            <div>
              <span class="stat-number">${roomData.maxGuests}</span>
              <span class="stat-label">Guests</span>
            </div>
          </div>

          <!-- Amenities -->
          <h3 class="section-title" style="font-size: 1.5rem; margin-bottom: 1rem">
            Amenities
          </h3>
          ${roomData.amenities}

          <!-- Sensory Specs -->
          ${roomData.sensorySpecs}

          <!-- Key Sensory Highlights -->
          ${
            roomData.lightOrientation || roomData.bedding || roomData.bath ? `
            <div class="sensory-highlights" style="margin-top: 2rem; display: flex; flex-direction: column; gap: 0.75rem;">
              ${roomData.lightOrientation ? `
                <div class="sensory-highlight">
                  <span class="highlight-label">Light</span>
                  <span class="highlight-value">${roomData.lightOrientation}</span>
                </div>
              ` : ''}
              ${roomData.bedding ? `
                <div class="sensory-highlight">
                  <span class="highlight-label">Bedding</span>
                  <span class="highlight-value">${roomData.bedding}</span>
                </div>
              ` : ''}
              ${roomData.bath ? `
                <div class="sensory-highlight">
                  <span class="highlight-label">Bath</span>
                  <span class="highlight-value">${roomData.bath}</span>
                </div>
              ` : ''}
            </div>
          ` : ''
          }

          <!-- Policies -->
          <div
            style="
              margin-top: 2rem;
              padding-top: 2rem;
              border-top: 1px solid var(--divider);
            "
          >
            <h3 class="section-title" style="font-size: 1.25rem; margin-bottom: 1rem">
              Policies
            </h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
              "
            >
              <div>
                <span class="meta-text">Check-in</span>
                <p class="body-text" style="margin-top: 0.25rem">
                  3:00 PM onwards
                </p>
              </div>
              <div>
                <span class="meta-text">Check-out</span>
                <p class="body-text" style="margin-top: 0.25rem">
                  11:00 AM
                </p>
              </div>
              <div>
                <span class="meta-text">Cancellation</span>
                <p class="body-text" style="margin-top: 0.25rem">
                  Free up to 48 hours before
                </p>
              </div>
              <div>
                <span class="meta-text">Children</span>
                <p class="body-text" style="margin-top: 0.25rem">
                  Welcome of all ages
                </p>
              </div>
            </div>
          </div>
        `;

        // Build booking widget
        const bookingWidget = document.getElementById('booking-widget');
        bookingWidget.innerHTML = `
          <div style="text-align: center; margin-bottom: 1.5rem">
            <span class="price">${roomData.roomPrice}</span>
            <span class="price-period">/ night</span>
          </div>

          <!-- Date Selection -->
          <div class="form-group">
            <label class="form-label">Check-in</label>
            <input
              type="text"
              id="checkInDate"
              class="form-field"
              placeholder="Select date"
            />
          </div>

          <div class="form-group">
            <label class="form-label">Check-out</label>
            <input
              type="text"
              id="checkOutDate"
              class="form-field"
              placeholder="Select date"
            />
          </div>

          <!-- Guest Selection -->
          <div class="form-group">
            <label class="form-label">Guests</label>
            <div
              class="guest-selector"
              style="display: flex; align-items: center; gap: 1rem"
            >
              <button
                class="btn-text-only"
                id="guestDecrease"
                style="font-size: 1.5rem; padding: 0.5rem"
              >
                −
              </button>
              <span
                id="guestDisplay"
                style="font-family: var(--font-heading); font-size: 1.25rem"
                >2</span
              >
              <input
                type="number"
                id="guestCount"
                value="2"
                min="1"
                max="6"
                style="
                  width: 50px;
                  text-align: center;
                  border: none;
                  background: transparent;
                  font-family: var(--font-heading);
                  font-size: 1.25rem;
                "
              />
              <button
                class="btn-text-only"
                id="guestIncrease"
                style="font-size: 1.5rem; padding: 0.5rem"
              >
                +
              </button>
            </div>
          </div>

          <!-- Price Summary -->
          <div class="booking-summary" style="margin-top: 1.5rem">
            <div class="booking-row">
              <span class="booking-label" id="roomRate">${roomData.roomPrice} × 1 night</span>
              <span class="booking-value" id="subtotal">${roomData.roomPrice}</span>
            </div>
            <div class="booking-row">
              <span class="booking-label">Taxes & fees (10%)</span>
              <span class="booking-value" id="taxAmount">${roomData.roomPrice.replace(/[^\d]/g, '') * 0.1}</span>
            </div>
            <div class="booking-total">
              <span class="booking-total-label">Total</span>
              <span class="booking-total-value" id="totalAmount">${Math.round(roomData.roomPrice.replace(/[^\d]/g, '') * 1.1)}</span>
            </div>
          </div>

          <a
            href="/booking.html"
            class="btn btn-primary gold"
            id="bookNowLink"
            style="width: 100%; justify-content: center; margin-top: 1.5rem"
          >
            Book Now
          </a>

          <p
            class="text-small"
            style="
              text-align: center;
              margin-top: 1rem;
              color: var(--brown);
            "
          >
            You won't be charged yet
          </p>
        `;

        // Update related rooms
        document.getElementById('related-rooms-container').innerHTML = roomData.relatedRooms;

        // Initialize gallery click handlers
        initGallery();

        // Initialize date picker
        initDatePicker(room);

        // Initialize guest selector
        initGuestSelector(room);

        // Initialize booking link
        initBookingLink(roomSlug);

        // Store room in state
        if (window.State) {
          window.State.setBooking({ room });
        }

        // Hide loading overlay and show content
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        
        // Small delay for smooth transition
        setTimeout(() => {
          loadingOverlay.style.opacity = '0';
          loadingOverlay.style.visibility = 'hidden';
          loadingOverlay.style.transition = 'opacity 0.5s ease, visibility 0.5s ease';
          
          mainContent.style.transition = 'opacity 0.8s ease';
          mainContent.style.opacity = '1';
          
          // Remove loading overlay from DOM after transition
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 500);
        }, 300);

        // Handle home page booking data
        const homeBookingData = sessionStorage.getItem('homeBookingData');
        if (homeBookingData) {
          const parsed = JSON.parse(homeBookingData);
          
          if (parsed.checkIn && document.getElementById('checkInDate')) {
            document.getElementById('checkInDate').value = parsed.checkIn;
          }
          if (parsed.checkOut && document.getElementById('checkOutDate')) {
            document.getElementById('checkOutDate').value = parsed.checkOut;
          }
          if (parsed.guests) {
            document.getElementById('guestCount').value = Math.min(parsed.guests, room.guests);
            document.getElementById('guestDisplay').textContent = Math.min(parsed.guests, room.guests);
          }
          
          if (parsed.checkIn && parsed.checkOut) {
            setTimeout(() => updatePrice(), 100);
          }
          
          sessionStorage.removeItem('homeBookingData');
        }

        // Initialize Lenis smooth scrolling
        initLenis();

        // Initialize scroll animations
        initScrollAnimations();

        // Initialize navigation menu
        initNavigation();

        function initGallery() {
          const mainImage = document.getElementById('main-image');
          const thumbs = document.querySelectorAll('.gallery-thumb');

          thumbs.forEach((thumb) => {
            thumb.addEventListener('click', () => {
              thumbs.forEach((t) => t.classList.remove('active'));
              thumb.classList.add('active');
              
              const newSrc = thumb.dataset.src;
              
              gsap.fromTo(mainImage, 
                { opacity: 0.8 },
                { opacity: 1, duration: 0.3 }
              );
              
              mainImage.src = newSrc;
            });
          });
        }

        function initDatePicker(room) {
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);

          const checkIn = flatpickr('#checkInDate', {
            minDate: today,
            defaultDate: today,
            dateFormat: 'Y-m-d',
            onChange: (selectedDates, dateStr) => {
              const checkOutPicker = document.getElementById('checkOutDate')._flatpickr;
              checkOutPicker.set('minDate', dateStr);
              checkOutPicker.open();
              updatePrice();
            },
          });

          const checkOut = flatpickr('#checkOutDate', {
            minDate: tomorrow,
            defaultDate: tomorrow,
            dateFormat: 'Y-m-d',
            onChange: updatePrice,
          });

          function updatePrice() {
            const checkInDate = document.getElementById('checkInDate').value;
            const checkOutDate = document.getElementById('checkOutDate').value;

            if (checkInDate && checkOutDate) {
              const nights = Math.ceil(
                (new Date(checkOutDate) - new Date(checkInDate)) /
                  (1000 * 60 * 60 * 24)
              );
              const pricePerNight = room.price;
              const subtotal = pricePerNight * nights;
              const tax = subtotal * 0.1;
              const total = subtotal + tax;

              const priceFormatted = `₦${pricePerNight.toLocaleString()}`;
              const subtotalFormatted = `₦${subtotal.toLocaleString()}`;
              const taxFormatted = `₦${tax.toLocaleString()}`;
              const totalFormatted = `₦${total.toLocaleString()}`;

              document.getElementById('roomRate').textContent = `${priceFormatted} × ${nights} night${nights > 1 ? 's' : ''}`;
              document.getElementById('subtotal').textContent = subtotalFormatted;
              document.getElementById('taxAmount').textContent = taxFormatted;
              document.getElementById('totalAmount').textContent = totalFormatted;
            }
          }

          // Expose updatePrice for use in guest selector
          window.updatePrice = updatePrice;
        }

        function initGuestSelector(room) {
          const guestInput = document.getElementById('guestCount');
          const guestDisplay = document.getElementById('guestDisplay');
          const maxGuests = room.guests || 6;

          document.getElementById('guestIncrease').addEventListener('click', () => {
            if (parseInt(guestInput.value) < maxGuests) {
              guestInput.value = parseInt(guestInput.value) + 1;
              guestDisplay.textContent = guestInput.value;
              if (typeof updatePrice === 'function') updatePrice();
            }
          });

          document.getElementById('guestDecrease').addEventListener('click', () => {
            if (parseInt(guestInput.value) > 1) {
              guestInput.value = parseInt(guestInput.value) - 1;
              guestDisplay.textContent = guestInput.value;
              if (typeof updatePrice === 'function') updatePrice();
            }
          });

          guestInput.addEventListener('change', () => {
            if (parseInt(guestInput.value) > maxGuests) {
              guestInput.value = maxGuests;
              guestDisplay.textContent = maxGuests;
            }
            if (typeof updatePrice === 'function') updatePrice();
          });
        }

        function initBookingLink(roomSlug) {
          const bookBtn = document.getElementById('bookNowLink');
          
          bookBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            const checkInDate = document.getElementById('checkInDate').value;
            const checkOutDate = document.getElementById('checkOutDate').value;
            const guests = parseInt(document.getElementById('guestCount').value);

            const bookingData = {
              checkIn: checkInDate,
              checkOut: checkOutDate,
              guests,
              room: roomSlug,
            };
            
            sessionStorage.setItem('roomBookingData', JSON.stringify(bookingData));
            
            window.location.href = `/booking.html?room=${roomSlug}`;
          });
        }

        function initLenis() {
          if (typeof Lenis !== 'undefined') {
            const lenis = new Lenis({
              duration: 1.2,
              easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
              direction: 'vertical',
              gestureDirection: 'vertical',
              smooth: true,
              mouseMultiplier: 1,
              smoothTouch: false,
              touchMultiplier: 2,
            });

            if (typeof ScrollTrigger !== 'undefined') {
              lenis.on('scroll', ScrollTrigger.update);
            }

            gsap.ticker.add((time) => {
              lenis.raf(time * 1000);
            });

            gsap.ticker.lagSmoothing(0);

            document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
              anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                  lenis.scrollTo(target, {
                    offset: -100,
                    duration: 1.2,
                  });
                }
              });
            });

            window.lenis = lenis;
          }
        }

        function initScrollAnimations() {
          if (typeof gsap !== 'undefined' && typeof ScrollTrigger !== 'undefined') {
            gsap.registerPlugin(ScrollTrigger);
            
            // Animate elements on scroll
            const animatedElements = document.querySelectorAll('[data-animate]');
            
            animatedElements.forEach((el) => {
              gsap.fromTo(el,
                { opacity: 0, y: 30 },
                {
                  opacity: 1,
                  y: 0,
                  duration: 0.8,
                  ease: 'power3.out',
                  scrollTrigger: {
                    trigger: el,
                    start: 'top 85%',
                    toggleActions: 'play none none reverse'
                  }
                }
              );
            });
          }
        }


      })();
    </script>
  </body>
</html>

